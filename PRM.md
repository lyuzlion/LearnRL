
# 过程奖励模型（PRM）

## 1. 动机：为什么需要 PRM？

### 1.1 结果奖励模型（ORM）的局限性

传统的 RLHF 训练流程主要依赖**结果级奖励**（Outcome Reward）：

仅对**最终答案**给出一个标量奖励，这会导致：**奖励信号极其稀疏**、长推理链中的**信用分配问题（credit assignment）**


### 1.2 PRM 的核心思想
\[
R = \sum_{t=1}^{T} r(s_t, a_t)
\]

其中：

* \( s_t \)：当前的部分推理状态（token 前缀、思维链、对话状态）
* \( a_t \)：当前的推理动作（一个 token 块、一个推理步骤、一次发言）

**PRM 为推理过程提供了稠密、逐步的监督信号。**


## 2. 形式化问题定义

### 2.1 将推理建模为 MDP

PRM 假设推理过程可以建模为一个马尔可夫决策过程（MDP）：

| 组成         | 定义                |
| ---------- | ----------------- |
| 状态 \( s_t \) | 当前已生成的部分推理轨迹      |
| 动作 \( a_t \) | 下一个推理步骤或 token 片段 |
| 状态转移       | 确定性（自回归生成）        |
| 奖励 \( r_t \) | 当前推理步骤的质量         |
| Episode    | 完整推理链             |


常见输出形式包括：

* 二分类（步骤是否正确）
* 有序等级（差 / 中 / 好）
* 连续标量（例如 \([-1, 1]\)）


## 3. PRM 的数据构建流程

### 3.1 推理轨迹生成

首先生成**多样化的推理轨迹**：

* 使用基础模型采样（较高 temperature）
* 每个问题生成多条解题路径
* 必须包含：

  * 正确解
  * 看似合理但错误的推理
  * 不完整推理
  * 投机取巧的捷径解法

**多样性是 PRM 可判别性的关键。**


### 3.2 推理步骤切分

明确“什么是一个 step”：

* 数学：一次公式变换或逻辑推导
* 代码：一行或一个代码块
* 对话：一次策略选择或一轮对话
* CoT：自然语言中的一步思考

一致性比粒度本身更重要。


### 3.3 人工标注（核心瓶颈）

标注者需要对**每一个步骤**进行判断，而不仅是最终答案。

常见标注方式包括：

#### （1）步骤正确性判断

> “在已有上下文下，这一步是否逻辑成立？”

#### （2）局部轨迹偏好比较

> “截至目前，哪一条推理轨迹更好？”

#### （3）错误定位

> 标记第一个错误步骤，后续步骤继承负奖励。

#### （4）策略感知标注（高级）

> 判断该步骤是否提高了最终解答正确的概率。


## 4. PRM 模型结构



### 4.3 输出头设计

* 标量回归头
* 分类头
* 成对排序头（Bradley–Terry）


## 5. PRM 的训练目标

### 5.1 点式监督（Pointwise）

\[
\mathcal{L}_{\text{MSE}} = \mathbb{E}[(\hat{r}_t - r_t)^2]
\]


### 5.2 成对偏好学习

对两条部分轨迹 \( \tau^+ , \tau^- \)：
\[
\mathcal{L} = -\log \sigma(R(\tau^+) - R(\tau^-))
\]

其中：
\[
R(\tau) = \sum_t \hat{r}_t
\]


## 6. PRM 在强化学习训练中的使用

### 6.1 作为稠密奖励信号

在 PPO / GRPO / A2C 等算法中：
\[
r_t = \text{PRM}(s_t, a_t)
\]

### 6.2 与结果奖励结合

实际系统中常用：
\[
r_t = \alpha \cdot r^{\text{PRM}}*t + \beta \cdot r^{\text{ORM}}*{\text{final}}
\]

PRM 约束“如何思考”，ORM 保证“最终到达正确答案”。

## 7. PRM 在推理阶段（Inference）的作用

### 7.1 推理路径重排序

* 采样 (K) 条推理链
* 使用 PRM 对每一步评分
* 选择累计 PRM 得分最高的路径

通常优于多数投票。

## 8. ORM 与 PRM 对比总结

| 维度    | ORM  | PRM |
| ----- | ---- | --- |
| 监督粒度  | 最终答案 | 每一步 |
| 奖励密度  | 稀疏   | 稠密  |
| 信用分配  | 差    | 强   |
| 长任务能力 | 弱    | 强   |
| 标注成本  | 低    | 高   |

